<body>
<meta charset="UTF-8"/>
<meta
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        name="viewport"
/>
<meta content="ie=edge" http-equiv="X-UA-Compatible"/>
<link href="css/output.css" rel="stylesheet"/>
<link
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        rel="stylesheet"
/>

<div class="p-2 hidden invisible">
    <div class="accordion">
        <div class="accordion-item">
            <section class="m-auto w-100">
                <h3 class="accordion-header text-center" id="headingOne">
                    <button
                            aria-controls="collapse_myAddr"
                            aria-expanded="true"
                            class="accordion-button collapsed"
                            data-bs-target="#collapse_myAddr"
                            data-bs-toggle="collapse"
                            type="button"
                    >
                        myAddr
                    </button>
                </h3>
                <div
                        aria-labelledby="headingOne"
                        class="accordion-collapse collapse"
                        data-bs-parent="#accordionExample"
                        id="collapse_myAddr"
                >
                    <div class="accordion-body">
                        <form class="d-flex flex-column gap-2 p-2" id="form-myAddr">
                            <div>
                                <button
                                        class="btn btn-primary mt-2"
                                        data-form-name="myAddr"
                                        id="btn"
                                        type="button"
                                >
                                    Read
                                </button>
                            </div>
                            <div>
                                <p>Response:</p>
                                <div>
                                    :
                                    <span
                                            data-field-type="address"
                                            data-form-name="myAddr"
                                            id="form-output-myAddr-0"
                                    >address</span
                                    >
                                    <br/>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<main
        class="flex flex-col items-center w-full pt-20"
        style="min-height: 1000px"
>
    <div class="absolute z-20 flex flex-col items-center gap-4 top-4 right-6">
        <button
                class="p-2 rounded-md shadow-xl border-2 border-gray-300 flex items-center block font-medium text-gray-600 hs-dark-mode-active:hidden hs-dark-mode group hover:text-blue-600 dark:text-neutral-400 dark:hover:text-neutral-500"
                data-hs-theme-click-value="dark"
                type="button"
        >
            <svg
                    class="flex-shrink-0 size-4"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
            >
                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
        </button>
        <button
                class="p-2 rounded-md shadow-xl border-2 border-neutral-800 flex items-center hidden font-medium text-gray-600 hs-dark-mode-active:block hs-dark-mode group hover:text-blue-600 dark:text-neutral-400 dark:hover:text-neutral-500"
                data-hs-theme-click-value="light"
                type="button"
        >
            <svg
                    class="flex-shrink-0 size-4"
                    fill="none"
                    height="24"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                    width="24"
                    xmlns="http://www.w3.org/2000/svg"
            >
                <circle cx="12" cy="12" r="4"></circle>
                <path d="M12 2v2"></path>
                <path d="M12 20v2"></path>
                <path d="m4.93 4.93 1.41 1.41"></path>
                <path d="m17.66 17.66 1.41 1.41"></path>
                <path d="M2 12h2"></path>
                <path d="M20 12h2"></path>
                <path d="m6.34 17.66-1.41 1.41"></path>
                <path d="m19.07 4.93-1.41 1.41"></path>
            </svg>
        </button>
    </div>
    <p class="text-2xl text-center">MiniDAO - Client</p>
    <form
            class="relative mt-6 flex flex-col p-4 bg-white border border-gray-200 shadow-sm rounded-xl md:p-5 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 w-96 gap-4"
            id="form"
    >
        <button class="py-3 px-4 items-center gap-x-2 text-sm font-semibold rounded-lg border border-gray-200 text-gray-500 hover:border-blue-600 hover:text-blue-600 disabled:opacity-50 disabled:pointer-events-none dark:border-neutral-700 dark:text-neutral-400 dark:hover:text-blue-500 dark:hover:border-blue-600" data-hs-overlay="#read-more-modal"
                type="button">
            Open info
        </button>
        <div>
            <label class="block text-sm font-medium mb-2 dark:text-white" for="addresses">Addresses</label>
            <textarea class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" id="addresses" name="addresses"
                      placeholder="Enter addresses (each address on a new line)"
                      rows="3" style="min-height: 86px; max-height: 300px;"></textarea>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2 dark:text-white" for="amounts">Amounts</label>
            <textarea class="py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" id="amounts" name="amounts"
                      placeholder="Enter amounts (each amount on a new line)"
                      rows="3" style="min-height: 86px; max-height: 300px;"></textarea>
        </div>

        <button class="py-3 px-4 items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none transition duration-150 active:scale-95"
                type="submit">
            Mint
        </button>

        <div id="form-loader" class="absolute top-0 start-0 w-full h-full bg-custom-blur rounded-lg flex items-center justify-center flex-col gap-2 hidden">
            <div class="animate-spin inline-block size-6" role="status" aria-label="loading">
                <svg class="fill-blue-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);"><path d="M12 22c5.421 0 10-4.579 10-10h-2c0 4.337-3.663 8-8 8s-8-3.663-8-8c0-4.336 3.663-8 8-8V2C6.579 2 2 6.58 2 12c0 5.421 4.579 10 10 10z"></path></svg>
            </div>
        </div>
    </form>
</main>

<div class="hs-overlay hidden size-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none"
     id="read-more-modal">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center">
        <div class="w-full flex flex-col bg-white border shadow-sm rounded-xl pointer-events-auto dark:bg-neutral-800 dark:border-neutral-700 dark:shadow-neutral-700/70">
            <div class="flex justify-between items-center py-3 px-4 border-b dark:border-neutral-700">
                <h3 class="font-bold text-gray-800 dark:text-white">
                    Info about token!
                </h3>
                <button class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-neutral-700"
                        data-hs-overlay="#read-more-modal"
                        type="button">
                    <span class="sr-only">Close</span>
                    <svg class="flex-shrink-0 size-4" fill="none" height="24" stroke="currentColor"
                         stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto">
                <p class="text-gray-800 dark:text-neutral-400">
                    Please be advised that token allocation among addresses can currently be executed only once. Any
                    additional issuance of tokens will be subject to a voting process. As an initial distributor, you
                    have the capability to allocate a significant number of tokens to yourself and manually distribute
                    the rest to other participants. This initial distribution is crucial and must be carefully planned
                    as subsequent emissions cannot be guaranteed without collective agreement. Choose your allocations
                    wisely to align with your strategic objectives and ensure a fair distribution process.
                </p>
            </div>
            <div class="flex justify-end items-center gap-x-2 py-3 px-4 border-t dark:border-neutral-700">
                <button class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800"
                        data-hs-overlay="#read-more-modal"
                        type="button">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
        class="fixed z-10 flex flex-col gap-4 items-center w-full top-4 w-96 min-h-10"
        id="toastContainer"
></div>

<script src="https://cdn.jsdelivr.net/npm/preline@2.1.0/dist/preline.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js" type="text/javascript"></script>
<script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
<script
        crossorigin="anonymous"
        integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw=="
        referrerpolicy="no-referrer"
        src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"
></script>
<!--    utils-->
<script>
    function showToast(message, status, timeout = 5000) {
        const toastContainer = document.getElementById('toastContainer')
        const toast = document.createElement('div')
        let htmlTemplate = ''
        switch (status) {
            case 'info':
                htmlTemplate = `
<div class="min-w-xs min-h-10 bg-white border border-gray-200 shadow-lg rounded-xl dark:bg-neutral-800 dark:border-neutral-700" role="alert">
<div class="flex p-4">
<div class="flex-shrink-0">
<svg class="flex-shrink-0 size-4 text-blue-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"></path>
	</svg>
	</div>
<div class="ms-3">
<p class="text-sm text-gray-700 dark:text-neutral-400">
${message}
	</p>
	</div>
	</div>
	</div>
`
                break
            case 'success':
                htmlTemplate = `
<div class="min-w-xs min-h-10 bg-white border border-gray-200 shadow-lg rounded-xl dark:bg-neutral-800 dark:border-neutral-700" role="alert">
<div class="flex p-4">
<div class="flex-shrink-0">
<svg class="flex-shrink-0 size-4 text-teal-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"></path>
	</svg>
	</div>
<div class="ms-3">
<p class="text-sm text-gray-700 dark:text-neutral-400">
${message}
	</p>
	</div>
	</div>
	</div>
`
                break
            case 'error':
                htmlTemplate = `
<div class="min-w-xs min-h-10 bg-white border border-gray-200 shadow-lg rounded-xl dark:bg-neutral-800 dark:border-neutral-700" role="alert">
<div class="flex p-4">
<div class="flex-shrink-0">
<svg class="flex-shrink-0 size-4 text-red-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"></path>
	</svg>
	</div>
<div class="ms-3">
<p class="text-sm text-gray-700 dark:text-neutral-400">
${message}
	</p>
	</div>
	</div>
	</div>
`
                break
            case 'warning':
                htmlTemplate = `
<div class="min-w-xs min-h-10 bg-white border border-gray-200 shadow-lg rounded-xl dark:bg-neutral-800 dark:border-neutral-700" role="alert">
<div class="flex p-4">
<div class="flex-shrink-0">
<svg class="flex-shrink-0 size-4 text-yellow-500 mt-0.5" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"></path>
	</svg>
	</div>
<div class="ms-3">
<p class="text-sm text-gray-700 dark:text-neutral-400">
${message}
	</p>
	</div>
	</div>
	</div>
`
                break
        }
        toast.innerHTML = htmlTemplate
        toastContainer.appendChild(toast)
        toast.classList.add(
            'animate__animated',
            'animate__faster',
            'animate__fadeInDown'
        )
        setTimeout(() => {
            toast.classList.remove('animate__fadeInDown')
            toast.classList.add('animate__fadeOutUp')
            setTimeout(() => {
                toastContainer.removeChild(toast)
            }, 500)
        }, timeout)
    }

    function shortenAddress(address) {
        if (address.length < 10) return address; // Если адрес слишком короткий, возвращаем его как есть
        return address.slice(0, 6) + "..." + address.slice(-5); // Возвращаем сокращенный адрес
    }

    const html = document.querySelector('html')
    const isLightOrAuto =
        localStorage.getItem('hs_theme') === 'light' ||
        (localStorage.getItem('hs_theme') === 'auto' &&
            !window.matchMedia('(prefers-color-scheme: dark)').matches)
    const isDarkOrAuto =
        localStorage.getItem('hs_theme') === 'dark' ||
        (localStorage.getItem('hs_theme') === 'auto' &&
            window.matchMedia('(prefers-color-scheme: dark)').matches)
    if (isLightOrAuto && html.classList.contains('dark'))
        html.classList.remove('dark')
    else if (isDarkOrAuto && html.classList.contains('light'))
        html.classList.remove('light')
    else if (isDarkOrAuto && !html.classList.contains('dark'))
        html.classList.add('dark')
    else if (isLightOrAuto && !html.classList.contains('light'))
        html.classList.add('light')
</script>


<!--    ethers init script-->
<script type="module">
    import {
        Contract,
        getDefaultProvider,
        BrowserProvider,
        Wallet,
        ethers
    } from 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.min.js'

    const tokenABI = [
        "function tokenDistribution(address[] to, uint256[] amount)",
        "function name() view returns (string)",
        "function decimals() view returns (uint256)",
        "function balanceOf(address) view returns (uint256)",
    ];
    const superDAOABI = [
        "function governor() view returns (address)",
        "function myAddr() view returns (address)",
        "function timeLock() view returns (address)",
        "function token() view returns (address)",
        "function treasury() view returns (address)",
    ];

    let contractAddress;
    let provider, signer, contract;

    const privateKey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80'
    contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3'
    provider = getDefaultProvider("http://127.0.0.1:8545/")
    signer = new Wallet(privateKey, provider)
    const super_contract = new Contract(contractAddress, superDAOABI, signer)
    let tokenAddress, token_contract;

    const initLocalApp = async () => {
        tokenAddress = await super_contract.token()
        token_contract = new Contract(tokenAddress, tokenABI, signer)
    }

    initLocalApp()

    // const getContractAddress = () => {
    //     const button = document.getElementById('btn')
    //     if (button) {
    //         button.click()
    //
    //         setTimeout(() => {
    //             contractAddress = document.getElementById(
    //                 "form-output-myAddr-0"
    //             ).innerHTML;
    //             console.log('contract address: ', contractAddress)
    //         }, 500)
    //     }
    // }
    //
    // const initApp = async () => {
    //     if (window.parent.ethereum == null) {
    //         console.log("MetaMask not installed; using read-only defaults")
    //         provider = getDefaultProvider()
    //
    //     } else {
    //         provider = new BrowserProvider(window.parent.ethereum)
    //
    //         signer = await provider.getSigner();
    //         contract = new Contract(contractAddress, abi, signer);
    //     }
    // }
    //
    // setTimeout(() => {
    //     getContractAddress()
    // }, 500)
    // setTimeout(() => {
    //     initApp().then(setInfo)
    // }, 1100)


    const form = document.getElementById('form')
    const formLoader = document.getElementById('form-loader')

    form.addEventListener('submit', async e => {
        e.preventDefault()

        const formData = new FormData(form);
        const addresses_input = formData.get("addresses");
        let addresses = addresses_input
            .split("\n")
            .map((address) => address.trim())
            .filter((address) => address.trim() !== "");

        const amounts_input = formData.get("amounts");

        const decimals = await token_contract.decimals();
        let amounts = amounts_input
            .split("\n")
            .map((amount) => amount.trim())
            .filter((amount) => amount.trim() !== "");

        let error;

        if (!Array.isArray(addresses) || !Array.isArray(amounts) || addresses.length !== amounts.length) {
            error = true;
        } else {
            // Проверяем каждый адрес на соответствие формату
            addresses.forEach((address) => {
                if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
                    error = true;
                }
            });

            // Проверяем каждое количество на число
            amounts.forEach((amount) => {
                if (isNaN(amount)) {
                    error = true;
                }
            });
        }

        if (error) {
            showToast(`The fields content contains invalid values!`, 'error');
            return
        } else {
            console.log(addresses, amounts);
            amounts = amounts.map((amount) => {
                let result = BigInt(amount)*10n**decimals
                return result.toString();
            });
            try {
                formLoader.classList.remove('hidden')
                await token_contract.tokenDistribution(addresses, amounts);
                showToast("All addresses minted successfully!", 'success');
                form.reset();
            } catch (err) {
                console.log(err)
                showToast('Error mint!', 'error')
            } finally {
                formLoader.classList.add('hidden')
            }
        }
    })
</script>
</body>
